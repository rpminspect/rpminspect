---
language: c
services:
  - docker

# Run everything in a Fedora container (created in before_install) so
# that we're not fighting with deps on two distros.
# Use the same paths both inside and outside the container so that
# the coverage stuff doesn't get confused.
env:
  DOCKER_RUN="docker run -v $PWD:$PWD --workdir $PWD rpminspect/test-env"

before_install:
  - docker build -t rpminspect/test-env -f Dockerfile.test .
  - gem install lcoveralls

script:
  - $DOCKER_RUN ./autogen.sh
  - $DOCKER_RUN ./configure --enable-code-coverage --enable-valgrind

  # Stop after the first failure, to keep the output more readable
  - |
    $DOCKER_RUN make check-code-coverage VERBOSE=y &&
    $DOCKER_RUN make check-valgrind VERBOSE=y &&
    $DOCKER_RUN make distcheck VERBOSE=y

after_success:
  # Upload the lcov info file generated by check-code-coverage
  - lcoveralls
